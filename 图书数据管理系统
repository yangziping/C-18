#include<stdio.h>
#include<stdlib.h>
#include<math.h>
#include<string.h>
struct SHUJU {char id[15];char name[20];char didian[25];int number;double price;//图书信息储存 
};
int main()
{
	int i=0,c,j=0,n,e,m,NUM;FILE *fp,*efp/*定义两个文件*/;char a[20],b[5]={'a','l','l','\0'},p[6]={'e','m','p','t','y','\0'};SHUJU book[20000];
	printf("请输入管理员密码:");
	scanf("%d",&c);
	if(c!=1234)//登录验证 
	{
		printf("密码错误,拒绝进入管理系统\n");//登录密码验证 
	    return 0;
	}
	printf("管理员书籍管理\n");
	if((efp=fopen("book","rt+"))==NULL)//打开计数文件 
	{
		printf("打开文件失败\n");
		exit(1);
	}
	printf("请选择进入模式，3为修改图书，2为查看图书，1为添加图书，0为初始化图书：");//选择操作模式 
	scanf("%d",&c);
	if(c==0)//初始化图书 
	{
		if((fp=fopen("books","wb"))==NULL)//打开文件 
		{
			printf("打开文件失败\n");
			exit(1);
		}
		printf("请输入增加书本数：");
	    scanf("%d",&NUM);
		for(;i<NUM;i++)
		{
			printf("请输入图书编号："); 
		    scanf("%s",&book[i].id);
		    printf("请输入图书名称："); 
		    scanf("%s",&book[i].name);
		    printf("请输入图书馆藏地：");
			scanf("%s",&book[i].didian);
		    printf("请输入图书本数：");
		    scanf("%d",&book[i].number);   
			printf("请输入图书借阅价格：");
			scanf("%lf",&book[i].price);	
		}
		fprintf(efp,"%d",NUM);//储存此次书的种类数到文件 
		rewind(efp); 	
	}
	fscanf(efp,"%d",&e);//读取上次保存的书的种类的数量,进行下面的重复判定和输出 
	rewind(efp);
	if(c==1)//读取文件中的值到内存中//增加图书 
	{
		if((fp=fopen("books","rb+"))==NULL)//打开文件 
		{
			printf("打开文件失败\n");
			exit(1);
		}
		for(i=0;i<e;i++)
			if(fread(&book[i],sizeof(SHUJU),1,fp)!=1)//读取文件数据至内存 
			{
				printf("文件读取信息提前终止\n");
				return 0;
			}
		m=e;//m用来方便在文件末尾添加书籍 
		printf("请输入增加书本数：");
	    scanf("%d",&NUM);
	    for(i=0;i<NUM;i++)
		{
		    printf("请输入图书名称："); 
		    scanf("%s",a);
		    for(j=0;j<e;j++)
			{
			  	if(strcmp(a,book[j].name)==0)//判定是否已有该图书 
			  	{
			  		printf("图书已经存在：");
			  		printf("请添加图书本数：");
		    		scanf("%d",&n);
				  	book[j].number=book[j].number+n;break;
				}
				if(strcmp(p,book[j].name)==0)
				{
					strcpy(book[j].name,a);
					printf("请输入图书编号："); 
		    		scanf("%s",&book[j].id);
		    		printf("请输入图书馆藏地：");
					scanf("%s",&book[j].didian);
		    		printf("请输入图书本数：");
		    		scanf("%d",&book[j].number);   
					printf("请输入图书借阅价格：");
					scanf("%lf",&book[j].price);break;	
				}
			  	if(j==e-1) //添加新的图书到文件末尾 
			  	{
			    	strcpy(book[m].name,a);
			    	printf("请输入图书编号："); 
		            scanf("%s",&book[m].id);
			    	printf("请输入图书馆藏地：");
			    	scanf("%s",&book[m].didian);
			    	printf("请输入图书本数：");
		    		scanf("%d",&book[m].number);
			    	printf("请输入图书借阅价格：");
			    	scanf("%lf",&book[m].price);
			    	m++;
				}
			}			
		} 
		e=m; 
		fprintf(efp,"%d",e);//储存此次书的种类数到文件 
	}
	if(3==c)
	{
		if((fp=fopen("books","rb+"))==NULL)//打开文件 
		{
			printf("打开文件失败\n");
			exit(1);
		}
		for(i=0;i<e;i++)
			if(fread(&book[i],sizeof(SHUJU),1,fp)!=1)//读取文件数据至内存 
			{
				printf("文件读取信息提前终止\n");
				return 0;
			}
		rewind(fp);
		printf("请输入图书名称："); 
		scanf("%s",a);
		for(j=0;j<e;j++)
			{
			  	if(strcmp(a,book[j].name)==0)//判定是否已有该图书 
			  	{
			  		printf("请输入修改方式，按0为修改本数，按1为修改馆藏地，按2为修改借阅价格,按3为修改id号："); 
			  		scanf("%d",&n);
					if(0==n) 
					{
						printf("请输入添加图书本数：");
		    			scanf("%d",&m);
		    			book[j].number=book[j].number+m;break;
					} 
					if(1==n)
					{
						printf("请输入修改后的地址：");
						scanf("%s",&book[j].didian);break;
					}
						if(2==n)
					{
						printf("请输入修改后的借阅价格：");
						scanf("%lf",&book[j].price);break;
					}
						if(1==n)
					{
						printf("请输入修改后的id号：");
						scanf("%s",&book[j].id);break;
					}
				}	
				if(j==e-1)
				{
					printf("不存在这本书,请重新输入书名：");
					scanf("%s",a);
					j=-1;
				}
			}			
	} 
	fclose(efp);
	//关闭计数文件
	/*模式2查看已存书籍信息*/ 
	if(c==2)
	{
		c=0;
	  	if((fp=fopen("books","rb+"))==NULL)//打开文件 
		{
			printf("打开文件失败\n");
			exit(1);
		}
		for(i=0;i<e;i++)//储存文件内容至内存中
			if(fread(&book[i],sizeof(SHUJU),1,fp)!=1) 
			{
				printf("文件读出信息提前终止\n");
				fclose(fp);
				return 0;
			}
		printf("请输入图书名称,或输入all查看所有图书："); 
		scanf("%s",a);
		if(strcmp(a,b)==0)
		{
			for(i=0;i<e;i++)//查看某本图书信息 
			{
				printf("图书编号：%s\n",book[i].id);
		   		printf("图书名称：%s\n",book[i].name);
		   		printf("图书馆藏地点：%s\n",book[i].didian);
		  		printf("图书剩余本数：%d\n",book[i].number);
		   		printf("图书借阅价格：%.2lf\n\n",book[i].price);
		   		c=c+book[i].number;
			}
			printf("图书总本数为%d\n",c);
		} 
		else
		  	for(i=0;i<e;i++)//查看某本图书信息
			{
			  	if(strcmp(a,book[i].name)==0) 
		  		{
					printf("图书编号：%s\n",book[i].id);
		   			printf("图书名称：%s\n",book[i].name);
		   			printf("图书馆藏地点：%s\n",book[i].didian);
		  			printf("图书剩余本数：%d\n",book[i].number);
		   			printf("图书借阅价格：%.2lf\n",book[i].price);
		   			printf("是否销除该书,按1为销书，按0为退出:");
					scanf("%d",&m);
					if(1==m)
					{
						strcpy(book[i].id,p);strcpy(book[i].didian,p);strcpy(book[i].name,p);book[i].number=0;book[i].price=0;
					}	
					break;
		  		}
		  		if(i==e-1)
		  		{
		  		    printf("不存在这本书,请重新输入书名：");
					scanf("%s",a);
					i=-1;	
				}	 		
			}	
	} 
	rewind(fp);
	for(i=0;i<e;i++)
		if(fwrite(&book[i],sizeof(SHUJU),1,fp)!=1)//储存至文件中 
		{
			printf("文件写入信息提前终止\n");
			return 0;
		}
	printf("书本信息更新成功\n");
	fclose(fp);
	return 0;	
}
